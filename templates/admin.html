<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TrueValue.ae — Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            navy: { 900: '#0a0e1a', 800: '#111827', 700: '#1a2035', 600: '#243049' },
            gold: { 400: '#f5b942', 500: '#d4982a' },
          }
        }
      }
    }
  </script>
  <style>
    body { background: #0a0e1a; color: #e2e8f0; font-family: 'Inter', system-ui, sans-serif; }
    .card { background: #111827; border: 1px solid #1e293b; border-radius: 12px; }
    .card-glow { box-shadow: 0 0 30px rgba(245, 185, 66, 0.03); }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #111827; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    .spinner { border: 3px solid #1e293b; border-top-color: #f5b942; border-radius: 50%; width: 32px; height: 32px; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    canvas { max-height: 260px; }
  </style>
</head>
<body class="min-h-screen">

  <!-- Header -->
  <header class="border-b border-gray-800 px-6 py-4">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-lg bg-gold-400/20 flex items-center justify-center">
          <span class="text-gold-400 font-bold text-sm">TV</span>
        </div>
        <div>
          <h1 class="text-lg font-bold">TrueValue<span class="text-gold-400">.ae</span></h1>
          <p class="text-xs text-gray-500">Admin Dashboard</p>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <span id="last-refresh" class="text-xs text-gray-500"></span>
        <button onclick="loadAll()" class="px-3 py-1.5 bg-gold-400/10 text-gold-400 text-xs font-medium rounded-lg hover:bg-gold-400/20 transition">
          Refresh
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-6 space-y-6">

    <!-- Loading -->
    <div id="loading" class="flex items-center justify-center py-20">
      <div class="spinner"></div>
      <span class="ml-3 text-gray-400 text-sm">Loading dashboard...</span>
    </div>

    <!-- Content (hidden until loaded) -->
    <div id="content" class="hidden space-y-6">

      <!-- KPI Cards -->
      <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
        <div class="card p-4">
          <div class="text-xs text-gray-500 uppercase tracking-wider">Total Users</div>
          <div id="kpi-users" class="text-2xl font-bold mt-1">-</div>
          <div id="kpi-users-today" class="text-xs text-green-400 mt-0.5"></div>
        </div>
        <div class="card p-4">
          <div class="text-xs text-gray-500 uppercase tracking-wider">Queries Today</div>
          <div id="kpi-queries-today" class="text-2xl font-bold mt-1">-</div>
          <div id="kpi-queries-7d" class="text-xs text-gray-400 mt-0.5"></div>
        </div>
        <div class="card p-4">
          <div class="text-xs text-gray-500 uppercase tracking-wider">Total Queries</div>
          <div id="kpi-total-queries" class="text-2xl font-bold mt-1">-</div>
        </div>
        <div class="card p-4">
          <div class="text-xs text-gray-500 uppercase tracking-wider">AI Cost (USD)</div>
          <div id="kpi-cost" class="text-2xl font-bold mt-1">-</div>
          <div id="kpi-avg-cost" class="text-xs text-gray-400 mt-0.5"></div>
        </div>
        <div class="card p-4">
          <div class="text-xs text-gray-500 uppercase tracking-wider">MRR (AED)</div>
          <div id="kpi-mrr" class="text-2xl font-bold mt-1 text-gold-400">-</div>
          <div id="kpi-paid" class="text-xs text-gray-400 mt-0.5"></div>
        </div>
        <div class="card p-4">
          <div class="text-xs text-gray-500 uppercase tracking-wider">Success Rate</div>
          <div id="kpi-success" class="text-2xl font-bold mt-1 text-green-400">-</div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="grid md:grid-cols-2 gap-4">
        <!-- User Signups -->
        <div class="card p-5">
          <h3 class="text-sm font-semibold text-gray-400 mb-3">User Signups (14d)</h3>
          <canvas id="chart-signups"></canvas>
        </div>
        <!-- Query Volume -->
        <div class="card p-5">
          <h3 class="text-sm font-semibold text-gray-400 mb-3">Query Volume (30d)</h3>
          <canvas id="chart-queries"></canvas>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <!-- Tool Usage -->
        <div class="card p-5">
          <h3 class="text-sm font-semibold text-gray-400 mb-3">Tool Usage (30d)</h3>
          <canvas id="chart-tools"></canvas>
        </div>
        <!-- Tier Distribution -->
        <div class="card p-5">
          <h3 class="text-sm font-semibold text-gray-400 mb-3">User Tiers</h3>
          <canvas id="chart-tiers"></canvas>
        </div>
      </div>

      <!-- Engagement Row -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
        <div class="card p-4 text-center">
          <div class="text-xs text-gray-500">Active 24h</div>
          <div id="eng-24h" class="text-xl font-bold mt-1">-</div>
        </div>
        <div class="card p-4 text-center">
          <div class="text-xs text-gray-500">Active 7d</div>
          <div id="eng-7d" class="text-xl font-bold mt-1">-</div>
        </div>
        <div class="card p-4 text-center">
          <div class="text-xs text-gray-500">Avg Queries/User</div>
          <div id="eng-avg" class="text-xl font-bold mt-1">-</div>
        </div>
        <div class="card p-4 text-center">
          <div class="text-xs text-gray-500">Saved Properties</div>
          <div id="eng-saved" class="text-xl font-bold mt-1">-</div>
        </div>
        <div class="card p-4 text-center">
          <div class="text-xs text-gray-500">Avg Response Time</div>
          <div id="eng-rt" class="text-xl font-bold mt-1">-</div>
        </div>
      </div>

      <!-- Users Table -->
      <div class="card p-5 card-glow overflow-x-auto">
        <h3 class="text-sm font-semibold text-gray-400 mb-3">All Users</h3>
        <table class="w-full text-sm">
          <thead>
            <tr class="text-xs text-gray-500 uppercase tracking-wider border-b border-gray-800">
              <th class="text-left pb-2 pr-4">User</th>
              <th class="text-left pb-2 pr-4">Tier</th>
              <th class="text-right pb-2 pr-4">Queries</th>
              <th class="text-right pb-2 pr-4">Today</th>
              <th class="text-right pb-2 pr-4">Saved</th>
              <th class="text-right pb-2 pr-4">Referrals</th>
              <th class="text-left pb-2">Joined</th>
            </tr>
          </thead>
          <tbody id="users-table"></tbody>
        </table>
      </div>

      <!-- Top Users by Queries -->
      <div class="card p-5 overflow-x-auto">
        <h3 class="text-sm font-semibold text-gray-400 mb-3">Top Users by Query Volume</h3>
        <table class="w-full text-sm">
          <thead>
            <tr class="text-xs text-gray-500 uppercase tracking-wider border-b border-gray-800">
              <th class="text-left pb-2 pr-4">#</th>
              <th class="text-left pb-2 pr-4">User</th>
              <th class="text-left pb-2 pr-4">Tier</th>
              <th class="text-right pb-2">Total Queries</th>
            </tr>
          </thead>
          <tbody id="top-users-table"></tbody>
        </table>
      </div>

      <!-- Revenue Events -->
      <div class="card p-5 overflow-x-auto">
        <h3 class="text-sm font-semibold text-gray-400 mb-3">Revenue & Subscription Events</h3>
        <div id="revenue-empty" class="text-sm text-gray-500 py-4 text-center hidden">No subscription events yet</div>
        <table id="revenue-table-wrap" class="w-full text-sm">
          <thead>
            <tr class="text-xs text-gray-500 uppercase tracking-wider border-b border-gray-800">
              <th class="text-left pb-2 pr-4">Date</th>
              <th class="text-left pb-2 pr-4">Event</th>
              <th class="text-left pb-2 pr-4">Tier</th>
              <th class="text-right pb-2 pr-4">Amount (AED)</th>
              <th class="text-right pb-2">User ID</th>
            </tr>
          </thead>
          <tbody id="revenue-table"></tbody>
        </table>
      </div>

    </div><!-- /content -->
  </main>

  <footer class="border-t border-gray-800 mt-8 py-4 text-center text-xs text-gray-600">
    TrueValue.ae Admin Dashboard &mdash; Data refreshes on page load
  </footer>

<script>
const API = '/admin/api';
let charts = {};

function fmt(n) {
  if (n === null || n === undefined) return '-';
  if (typeof n === 'number') {
    if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
    if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
    return n.toLocaleString();
  }
  return n;
}

function tierBadge(tier) {
  const colors = { free: 'bg-gray-700 text-gray-300', basic: 'bg-blue-900/50 text-blue-300', pro: 'bg-gold-400/20 text-gold-400', enterprise: 'bg-purple-900/50 text-purple-300' };
  return `<span class="px-2 py-0.5 rounded-full text-[10px] font-medium ${colors[tier] || colors.free}">${tier}</span>`;
}

function relTime(iso) {
  if (!iso) return '-';
  const d = new Date(iso);
  const diff = (Date.now() - d) / 1000;
  if (diff < 60) return 'just now';
  if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
  return Math.floor(diff / 86400) + 'd ago';
}

const chartDefaults = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: { legend: { display: false } },
  scales: {
    x: { grid: { color: '#1e293b' }, ticks: { color: '#64748b', font: { size: 10 } } },
    y: { grid: { color: '#1e293b' }, ticks: { color: '#64748b', font: { size: 10 } }, beginAtZero: true }
  }
};

function makeChart(id, type, labels, data, color, opts = {}) {
  if (charts[id]) charts[id].destroy();
  const ctx = document.getElementById(id).getContext('2d');
  const cfg = {
    type,
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: type === 'doughnut' ? color : (color + '33'),
        borderColor: type === 'doughnut' ? color : color,
        borderWidth: type === 'doughnut' ? 0 : 2,
        tension: 0.3,
        fill: type === 'line',
        pointRadius: type === 'line' ? 2 : undefined,
      }]
    },
    options: type === 'doughnut'
      ? { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 11 }, padding: 12 } } } }
      : { ...chartDefaults, ...opts }
  };
  charts[id] = new Chart(ctx, cfg);
}

async function loadAll() {
  try {
    const [overview, users, queries, tools, revenue, engagement] = await Promise.all([
      fetch(API + '/overview').then(r => r.json()),
      fetch(API + '/users').then(r => r.json()),
      fetch(API + '/queries').then(r => r.json()),
      fetch(API + '/tools').then(r => r.json()),
      fetch(API + '/revenue').then(r => r.json()),
      fetch(API + '/engagement').then(r => r.json()),
    ]);

    // KPIs
    document.getElementById('kpi-users').textContent = fmt(overview.total_users);
    document.getElementById('kpi-users-today').textContent = `+${overview.users_today} today / +${overview.users_7d} this week`;
    document.getElementById('kpi-queries-today').textContent = fmt(overview.queries_today);
    document.getElementById('kpi-queries-7d').textContent = `${fmt(overview.queries_7d)} this week`;
    document.getElementById('kpi-total-queries').textContent = fmt(overview.total_queries);
    document.getElementById('kpi-cost').textContent = '$' + overview.total_cost_usd.toFixed(2);
    document.getElementById('kpi-avg-cost').textContent = `$${overview.avg_cost_per_query.toFixed(4)} avg/query`;
    document.getElementById('kpi-mrr').textContent = fmt(revenue.mrr_aed);
    document.getElementById('kpi-paid').textContent = `${revenue.paid_users} paid users`;
    document.getElementById('kpi-success').textContent = overview.success_rate + '%';

    // Engagement
    document.getElementById('eng-24h').textContent = fmt(engagement.active_24h);
    document.getElementById('eng-7d').textContent = fmt(engagement.active_7d);
    document.getElementById('eng-avg').textContent = engagement.avg_queries_per_user;
    document.getElementById('eng-saved').textContent = fmt(engagement.total_saved_properties);
    document.getElementById('eng-rt').textContent = queries.avg_response_time_ms ? (queries.avg_response_time_ms / 1000).toFixed(1) + 's' : '-';

    // Charts — Signups
    const signupDays = engagement.signups_daily.map(r => r.day.slice(5));
    const signupCounts = engagement.signups_daily.map(r => r.cnt);
    makeChart('chart-signups', 'bar', signupDays, signupCounts, '#f5b942');

    // Charts — Query Volume
    const qDays = queries.daily_volume.map(r => r.day.slice(5));
    const qCounts = queries.daily_volume.map(r => r.cnt);
    makeChart('chart-queries', 'line', qDays, qCounts, '#38bdf8');

    // Charts — Tool Usage
    const toolNames = (tools.tool_usage_30d || []).map(r => r.tool.replace('_', ' '));
    const toolCounts = (tools.tool_usage_30d || []).map(r => r.cnt);
    makeChart('chart-tools', 'bar', toolNames, toolCounts, '#a78bfa', {
      ...chartDefaults,
      indexAxis: 'y',
      scales: {
        ...chartDefaults.scales,
        x: { ...chartDefaults.scales.x, beginAtZero: true },
        y: { ...chartDefaults.scales.y, ticks: { ...chartDefaults.scales.y.ticks, font: { size: 9 } } }
      }
    });

    // Charts — Tier Distribution
    const tierLabels = Object.keys(overview.tier_distribution);
    const tierValues = Object.values(overview.tier_distribution);
    const tierColors = tierLabels.map(t => ({ free: '#64748b', basic: '#3b82f6', pro: '#f5b942', enterprise: '#a855f7' }[t] || '#64748b'));
    makeChart('chart-tiers', 'doughnut', tierLabels, tierValues, tierColors);

    // Users Table
    const tbody = document.getElementById('users-table');
    tbody.innerHTML = users.map(u => `
      <tr class="border-b border-gray-800/50 hover:bg-gray-800/30">
        <td class="py-2 pr-4">
          <div class="font-medium">${u.first_name || '-'}</div>
          <div class="text-xs text-gray-500">@${u.telegram_username || u.user_id}</div>
        </td>
        <td class="py-2 pr-4">${tierBadge(u.tier)}</td>
        <td class="py-2 pr-4 text-right tabular-nums">${fmt(u.total_queries)}</td>
        <td class="py-2 pr-4 text-right tabular-nums">${u.queries_today}</td>
        <td class="py-2 pr-4 text-right tabular-nums">${u.saved_count}</td>
        <td class="py-2 pr-4 text-right tabular-nums">${u.referral_count}</td>
        <td class="py-2 text-gray-500 text-xs">${relTime(u.joined_at)}</td>
      </tr>
    `).join('');

    // Top Users
    const topTbody = document.getElementById('top-users-table');
    topTbody.innerHTML = queries.top_users.map((u, i) => `
      <tr class="border-b border-gray-800/50">
        <td class="py-2 pr-4 text-gray-500">${i + 1}</td>
        <td class="py-2 pr-4 font-medium">${u.first_name || u.telegram_username || u.user_id}</td>
        <td class="py-2 pr-4">${tierBadge(u.tier)}</td>
        <td class="py-2 text-right tabular-nums font-medium">${fmt(u.total_queries)}</td>
      </tr>
    `).join('');

    // Revenue Table
    if (revenue.recent_events.length === 0) {
      document.getElementById('revenue-empty').classList.remove('hidden');
      document.getElementById('revenue-table-wrap').classList.add('hidden');
    } else {
      document.getElementById('revenue-empty').classList.add('hidden');
      document.getElementById('revenue-table-wrap').classList.remove('hidden');
      document.getElementById('revenue-table').innerHTML = revenue.recent_events.map(e => `
        <tr class="border-b border-gray-800/50">
          <td class="py-2 pr-4 text-xs text-gray-400">${relTime(e.created_at)}</td>
          <td class="py-2 pr-4">${e.event_type}</td>
          <td class="py-2 pr-4">${tierBadge(e.to_tier || '-')}</td>
          <td class="py-2 pr-4 text-right tabular-nums">${e.amount_aed || 0}</td>
          <td class="py-2 text-right text-gray-500">${e.user_id}</td>
        </tr>
      `).join('');
    }

    // Show content
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('content').classList.remove('hidden');
    document.getElementById('last-refresh').textContent = 'Updated ' + new Date().toLocaleTimeString();

  } catch (err) {
    document.getElementById('loading').innerHTML = `
      <div class="text-center">
        <div class="text-red-400 text-sm mb-2">Failed to load dashboard</div>
        <div class="text-xs text-gray-500">${err.message}</div>
        <button onclick="loadAll()" class="mt-3 px-3 py-1.5 bg-gold-400/10 text-gold-400 text-xs rounded-lg">Retry</button>
      </div>
    `;
  }
}

// Auto-refresh every 60 seconds
loadAll();
setInterval(loadAll, 60000);
</script>
</body>
</html>
